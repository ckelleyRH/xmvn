<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 at 2023-03-20 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Mikolaj Izdebski" />
    <meta name="Date-Creation-yyyymmdd" content="20130312" />
    <meta name="Date-Revision-yyyymmdd" content="20230320" />
    <meta http-equiv="Content-Language" content="en" />
    <title>XMvn &#x2013; How to create an extension for XMvn</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
      <script type="text/javascript" src="../js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
            <ul class="nav">
          <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="../configuration.html" title="Configuration">Configuration</a></li>
            <li><a href="../config.html" title="Configuration Reference">Configuration Reference</a></li>
            <li><a href="../metadata.html" title="Metadata Reference">Metadata Reference</a></li>
            <li><a href="../apidocs/" title="API Documentation">API Documentation</a></li>
            <li><a href="../howto/index.html" title="Tutorials">Tutorials</a></li>
        </ul>
      </li>
              </ul>
            <ul class="nav pull-right">
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">External Links <b class="caret"></b></a>
                <ul class="dropdown-menu">
    <li><a href="http://fedoraproject.org/wiki/SIGs/Java" target="_blank" title="Fedora Java SIG">Fedora Java SIG</a></li>
    <li><a href="http://fedoraproject.org/wiki/Java" target="_blank" title="Fedora Java">Fedora Java</a></li>
    <li><a href="http://fedoraproject.org/" target="_blank" title="Fedora Project">Fedora Project</a></li>
    <li><a href="http://maven.apache.org/" target="_blank" title="Apache Maven">Apache Maven</a></li>
    <li><a href="http://plexus.codehaus.org/" target="_blank" title="Plexus">Plexus</a></li>
                </ul>
              </li>
            </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>XMvn</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2023-03-20<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 4.2.0</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
      <li><a href="../about.html" title="About XMvn"><span class="none"></span>About XMvn</a>  </li>
    <li><a href="../download.html" title="Download"><span class="none"></span>Download</a>  </li>
    <li><a href="../news.html" title="Release notes"><span class="none"></span>Release notes</a>  </li>
    <li><a href="../contact.html" title="Contact"><span class="none"></span>Contact</a>  </li>
    <li><a href="../copyright.html" title="Copyright"><span class="none"></span>Copyright</a>  </li>
          <li class="nav-header">Project Documentation</li>
    <li><a href="../configuration.html" title="Configuration"><span class="none"></span>Configuration</a>  </li>
    <li><a href="../config.html" title="Configuration Reference"><span class="none"></span>Configuration Reference</a>  </li>
    <li><a href="../metadata.html" title="Metadata Reference"><span class="none"></span>Metadata Reference</a>  </li>
    <li><a href="../apidocs/" title="API Documentation"><span class="none"></span>API Documentation</a>  </li>
    <li><a href="../howto/index.html" title="Tutorials"><span class="none"></span>Tutorials</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<section>
<h2><a name="How_to_create_an_extension_for_XMvn"></a>How to create an extension for XMvn</h2><section>
<h3><a name="Abstract"></a>Abstract</h3>
<p>In this short tutorial I am going to show you how you can extend functionality provided by XMvn. As an example I will create a very simple extension that allows XMvn to be used to install Eclipse artifacts.</p></section><section>
<h3><a name="Tutorial"></a>Tutorial</h3>
<p>First we'll start with creating a skeleton POM file. XMvn extensions don't use separate packaging type, you need to use packaging <code>jar</code> (which is default, so you can omit it). Obviously we need to add a dependency on XMvn Core as this module provides functionality we depend on. We'll use dependency scope <code>provided</code> as we need XMvn API to compile our extension, but during runtime XMvn will be provided for us (whatever loads our extension it will load XMvn first).</p>
<div>
<pre>  &lt;dependency&gt;
    &lt;groupId&gt;org.fedoraproject.xmvn&lt;/groupId&gt;
    &lt;artifactId&gt;xmvn-core&lt;/artifactId&gt;
    &lt;version&gt;0.4.0&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
  &lt;/dependency&gt;</pre></div>
<p>Now we can start writing some code. To create an installer for Eclipse artifacts we need to provide implementation for interface <code>org.fedoraproject.xmvn.installer.ProjectInstaller</code>. In order for XMvn to be able to find and load our extension we need to implement is as a Plexus component.</p>
<div>
<pre>@Component( role = ProjectInstaller.class )
public class EclipseInstaller
    implements ProjectInstaller
{
}</pre></div>
<p><code>ProjectInstaller</code> interface requires us to implement two abstract methods: <code>getSupportedPackagingTypes()</code> and <code>installProject()</code>.</p>
<p>The first method simply returns a <code>List</code> of packaging types supported by our extension. There are several Eclipse packaging types, but in this example I'll cover only three: <code>eclipse-plugin</code>, <code>eclipse-test-plugin</code> and <code>eclipse-feature</code>. In its simplest form the implementation of <code>getSupportedPackagingTypes()</code> could look like:</p>
<div>
<pre>    public List&lt;String&gt; getSupportedPackagingTypes()
    {
        // Return list of packaging types we support.
        return Arrays.asList( &quot;eclipse-plugin&quot;, &quot;eclipse-test-plugin&quot;, &quot;eclipse-feature&quot; );
    }</pre></div>
<p>Now it's time to implement the second method. Bundles are normal JAR files so we want to them into standard JAR location. Additionally we need to create additional symlinks in Eclipse directory so that Equinox can find and load these bundles.</p>
<p>Because we don't want to hardcode the location of JAR directory (and to show how to obtain and use configuration objects) we'll query standard XMvn configurator to give us the directory path. To obtain a reference to the configurator (or any other service provided by XMvn) it's enough to create a field of appropriate type (in this case <code>org.fedoraproject.xmvn.config.Configurator</code>) and annotate it with <code>org.codehaus.plexus.component.annotations.Requirement</code>. This way Plexus container will inject the dependency automatically.</p>
<div>
<pre>    // Configurator is dynamic dependency. This private field will be injected by Sisu during runtime.
    @Requirement
    private Configurator configurator;</pre></div>
<p>Once we have a reference to an instance of configurator we can ask it to give us the location of JAR directory and use it to create a <code>Path</code> object pointing to the target JAR file.</p>
<div>
<pre>        // Install all JARs into /usr/share/java (or whatever is configured as JAR dir)
        // FIXME: in JAR is platform-dependent install in into JNI dir instead
        Path javaDir = Paths.get( configurator.getConfiguration().getInstallerSettings().getJarDir() );
        Path target = javaDir.resolve( project.getArtifactId() );</pre></div>
<p>In a similar way we can decide where to place the symlink to the bundle (either in <code>features</code> or <code>plugins</code> directory). Of course this example is oversimplified, in real extension the path should not be hardcoded and there the code may a bit be more complicated.</p>
<div>
<pre>        // Create symlink to the JAR somewhere under /usr/lib64/eclipse/. In real plugin the location should be
        // configurable.
        Path eclipseDir = Paths.get( &quot;/usr/lib64/eclipse&quot; );
        eclipseDir = eclipseDir.resolve( project.getPackaging().contains( &quot;feature&quot; ) ? &quot;features&quot; : &quot;plugins&quot; );
        Path symlink = eclipseDir.resolve( project.getArtifactId() );</pre></div>
<p>After we decided where base JAR and the symlink should go we can just call <code>addJarFile()</code> method to perform the installation.</p>
<div>
<pre>        // So far we just determined paths to different files. Now it's time to call XMvn to do the real work.
        targetPackage.addJarFile( source, target, Collections.singletonList( symlink ) );</pre></div>
<p>We have used Maven API here so of course we need to add dependency on Maven Core to our POM.</p>
<div>
<pre>  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.maven&lt;/groupId&gt;
    &lt;artifactId&gt;maven-core&lt;/artifactId&gt;
    &lt;version&gt;3.2.1&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
  &lt;/dependency&gt;</pre></div>
<p>To generate all the metadata necessary for XMvn to recognize our extension we must run <code>generate-metadata</code> goal of <code>plexus-component-metadata</code> plugin. This is done by adding appropriate entry in the POM.</p>
<div>
<pre>  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.codehaus.plexus&lt;/groupId&gt;
        &lt;artifactId&gt;plexus-component-metadata&lt;/artifactId&gt;
        &lt;version&gt;1.5.5&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;id&gt;process-classes&lt;/id&gt;
            &lt;goals&gt;
              &lt;goal&gt;generate-metadata&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;</pre></div>
<p>After building the extension with famous <code>mvn clean install</code> we can place it in <code>lib/ext/</code> directory of XMvn installation. The extension will be automatically loaded by Plexus Classworlds during XMvn boot-up and implemented functionality will be available to packages built with XMvn out of the box.</p>
<p>Note that in this example I completely ignored POM installation. This is because this tutorial is supposed to be just a starting point to creating extensions and not complete documentation on this subject and I wanted to keep this it short and simple.</p>
<p>For more information refer to API documentation and source code for installers for standard packaging types (like <code>pom</code> or <code>jar</code>), which are implemented in XMvn itself.</p>
<p>Snippets of the complete source code for this example follow.</p>
<ul>
<li><code>pom.xml</code>:
<div>
<pre>&lt;project&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;com.example&lt;/groupId&gt;
  &lt;artifactId&gt;eclipse-xmvn-extension&lt;/artifactId&gt;
  &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.fedoraproject.xmvn&lt;/groupId&gt;
      &lt;artifactId&gt;xmvn-core&lt;/artifactId&gt;
      &lt;version&gt;0.4.0&lt;/version&gt;
      &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.maven&lt;/groupId&gt;
      &lt;artifactId&gt;maven-core&lt;/artifactId&gt;
      &lt;version&gt;3.2.1&lt;/version&gt;
      &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.codehaus.plexus&lt;/groupId&gt;
        &lt;artifactId&gt;plexus-component-metadata&lt;/artifactId&gt;
        &lt;version&gt;1.5.5&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;id&gt;process-classes&lt;/id&gt;
            &lt;goals&gt;
              &lt;goal&gt;generate-metadata&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;
&lt;/project&gt;</pre></div></li>
<li><code>src/main/java/EclipseInstaller.java</code>:
<div>
<pre>import java.io.IOException;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

import org.apache.maven.project.MavenProject;
import org.codehaus.plexus.component.annotations.Component;
import org.codehaus.plexus.component.annotations.Requirement;
import org.fedoraproject.xmvn.config.Configurator;
import org.fedoraproject.xmvn.config.PackagingRule;
import org.fedoraproject.xmvn.installer.Package;
import org.fedoraproject.xmvn.installer.ProjectInstallationException;
import org.fedoraproject.xmvn.installer.ProjectInstaller;

@Component( role = ProjectInstaller.class )
public class EclipseInstaller
    implements ProjectInstaller
{
    // Configurator is dynamic dependency. This private field will be injected by Sisu during runtime.
    @Requirement
    private Configurator configurator;

    public List&lt;String&gt; getSupportedPackagingTypes()
    {
        // Return list of packaging types we support.
        return Arrays.asList( &quot;eclipse-plugin&quot;, &quot;eclipse-test-plugin&quot;, &quot;eclipse-feature&quot; );
    }

    public void installProject( MavenProject project, Package targetPackage, PackagingRule rule )
        throws ProjectInstallationException, IOException
    {
        Path source = project.getArtifact().getFile().toPath();

        // Install all JARs into /usr/share/java (or whatever is configured as JAR dir)
        // FIXME: in JAR is platform-dependent install in into JNI dir instead
        Path javaDir = Paths.get( configurator.getConfiguration().getInstallerSettings().getJarDir() );
        Path target = javaDir.resolve( project.getArtifactId() );

        // Create symlink to the JAR somewhere under /usr/lib64/eclipse/. In real plugin the location should be
        // configurable.
        Path eclipseDir = Paths.get( &quot;/usr/lib64/eclipse&quot; );
        eclipseDir = eclipseDir.resolve( project.getPackaging().contains( &quot;feature&quot; ) ? &quot;features&quot; : &quot;plugins&quot; );
        Path symlink = eclipseDir.resolve( project.getArtifactId() );

        // So far we just determined paths to different files. Now it's time to call XMvn to do the real work.
        targetPackage.addJarFile( source, target, Collections.singletonList( symlink ) );

        // TODO: install POM file as well
    }
}</pre></div></li></ul></section></section>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2012&#x2013;2023
<a href="http://www.redhat.com/">Red Hat, Inc.</a>.
All rights reserved.</p>
        </div>
        </div>
    </footer>
    </body>
</html>
